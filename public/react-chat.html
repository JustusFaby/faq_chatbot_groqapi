<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ Chatbot</title>
    
    <!-- Robot emoji favicon for browser tab -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
    
    <!-- External libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Markdown rendering and sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.0/dist/purify.min.js"></script>
    
    <style>
        /* Animated gradient background that moves smoothly */
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .gradient-animation {
            background: linear-gradient(-45deg, #0f0f0f, #1a1a1a, #2d2d2d, #1a1a1a);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        /* Fade-in animation for new messages */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-enter { animation: fadeInUp 0.4s ease-out; }

        /* Typing indicator animation - pulsing dots */
        @keyframes typing { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .typing-indicator span { animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        /* Custom scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0a0a0a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #2d2d2d; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #404040; }

        /* Chat bubble content formatting */
        .message-content { white-space: pre-wrap; line-height: 1.7; }
        .message-content pre {
            background: #0b0b0b;
            border: 1px solid #2f2f2f;
            padding: 12px 14px;
            border-radius: 12px;
            overflow: auto;
            position: relative;
        }
        .message-content code { background: #0b0b0b; border: 1px solid #2f2f2f; border-radius: 8px; padding: 2px 6px; }
        .message-bubble { word-break: break-word; box-shadow: 0 6px 18px rgba(0,0,0,0.35); }

        /* Timestamp text */
        .timestamp { font-size: 11px; color: #9aa0a6; margin-top: 6px; }

        /* Copy button on code blocks */
        .copy-btn { position: absolute; top: 8px; right: 8px; font-size: 11px; padding: 4px 8px; background: #111827; color: #cbd5e1; border: 1px solid #374151; border-radius: 6px; cursor: pointer; }
        .copy-btn:hover { background: #1f2937; }
    </style>
</head>
<body>
    <!-- React app root element -->
    <div id="root"></div>

    <script type="text/babel">
        // Import React hooks
        const { useState, useEffect, useRef } = React;

        /**
         * Message Component
         * Displays individual chat messages with user/bot styling
         * @param {string} message - The message text to display
         * @param {boolean} isUser - True if message is from user, false if from bot
         * @param {string} messageId - Unique identifier for feedback tracking
         * @param {string} userQuestion - The original user question (for bot messages)
         * @param {function} onFeedback - Callback function when feedback is given
         * @param {string} feedbackType - Current feedback status ('positive', 'negative', or null)
         * @param {string} timestamp - Message timestamp
         */
        function Message({ message, isUser, messageId, userQuestion, onFeedback, feedbackType, timestamp }) {
            // Render Markdown safely
            const html = DOMPurify.sanitize(marked.parse(message || ''));
            const bubbleRef = useRef(null);
            useEffect(() => {
                const container = bubbleRef.current;
                if (!container) return;
                const pres = container.querySelectorAll('pre');
                pres.forEach(pre => {
                    pre.style.position = 'relative';
                    if (pre.querySelector('.copy-btn')) return; // avoid duplicate buttons
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.textContent = 'Copy';
                    btn.addEventListener('click', () => {
                        const text = pre.innerText || '';
                        navigator.clipboard.writeText(text).then(() => {
                            btn.textContent = 'Copied!';
                            setTimeout(() => (btn.textContent = 'Copy'), 1500);
                        });
                    });
                    pre.appendChild(btn);
                });
            }, [html]);
            return (
                <div className={`flex ${isUser ? 'justify-end flex-row-reverse' : ''} gap-3 px-6 py-4 message-enter`}>
                    {/* Avatar */}
                    <div className={`w-8 h-8 rounded flex items-center justify-center flex-shrink-0 ${
                        isUser 
                            ? 'bg-gradient-to-br from-teal-600 to-emerald-600 border border-teal-400' 
                            : 'bg-gradient-to-br from-gray-700 to-gray-600 border border-gray-500'
                    }`}>
                        <span className="text-lg">{isUser ? 'üë§' : 'ü§ñ'}</span>
                    </div>
                    {/* Bubble */}
                    <div className={`max-w-3xl ${isUser ? 'items-end' : ''}`}>
                        <div ref={bubbleRef} className={`message-bubble inline-block px-4 py-3 rounded-2xl ${
                            isUser 
                                ? 'bg-gradient-to-br from-teal-500 to-emerald-600 text-black rounded-br-md' 
                                : 'bg-gradient-to-br from-gray-800 to-gray-900 text-gray-200 rounded-bl-md border border-gray-700'
                        }`}>
                            <div className="message-content" dangerouslySetInnerHTML={{ __html: html }} />
                        </div>
                        {/* Timestamp */}
                        <div className={`timestamp ${isUser ? 'text-right' : 'text-left'}`}>
                            {timestamp ? new Date(timestamp).toLocaleString() : ''}
                        </div>
                        {/* Feedback buttons - bot only */}
                        {!isUser && messageId && (
                            <div className="flex gap-2 mt-2">
                                <button
                                    onClick={() => onFeedback(messageId, 'positive', userQuestion, message)}
                                    className={`flex items-center gap-1 px-3 py-1 rounded-lg text-xs transition-all duration-200 ${
                                        feedbackType === 'positive'
                                            ? 'bg-green-600 text-white border border-green-500'
                                            : 'bg-gray-800 text-gray-400 border border-gray-700 hover:bg-gray-700 hover:text-green-400'
                                    }`}
                                    title="Good response"
                                >
                                    <span>üëç</span>
                                    <span className="text-[11px]">Helpful</span>
                                </button>
                                <button
                                    onClick={() => onFeedback(messageId, 'negative', userQuestion, message)}
                                    className={`flex items-center gap-1 px-3 py-1 rounded-lg text-xs transition-all duration-200 ${
                                        feedbackType === 'negative'
                                            ? 'bg-red-600 text-white border border-red-500'
                                            : 'bg-gray-800 text-gray-400 border border-gray-700 hover:bg-gray-700 hover:text-red-400'
                                    }`}
                                    title="Needs improvement"
                                >
                                    <span>üëé</span>
                                    <span className="text-[11px]">Not helpful</span>
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        /**
         * TypingIndicator Component
         * Shows animated dots when bot is processing a response
         */
        function TypingIndicator() {
            return (
                <div className="flex gap-4 p-6 bg-gradient-to-r from-black to-gray-900 border-b border-gray-800">
                    {/* Bot avatar */}
                    <div className="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-gradient-to-br from-teal-500 to-emerald-600 border border-teal-400">
                        <span className="text-lg">ü§ñ</span>
                    </div>
                    {/* Animated dots */}
                    <div className="flex-1 pt-1 typing-indicator">
                        <span className="inline-block w-2 h-2 bg-teal-500 rounded-full mr-1"></span>
                        <span className="inline-block w-2 h-2 bg-teal-500 rounded-full mr-1"></span>
                        <span className="inline-block w-2 h-2 bg-teal-500 rounded-full"></span>
                    </div>
                </div>
            );
        }

        /**
         * ChatApp Component
         * Main application component managing chat state and interactions
         */
        function ChatApp() {
            // State management
            const [messages, setMessages] = useState([]); // Array of chat messages with feedback info
            const [inputValue, setInputValue] = useState(''); // Current input text
            const [isLoading, setIsLoading] = useState(false); // Loading state for API calls
            const [showUnanswered, setShowUnanswered] = useState(false); // Toggle unanswered queries view
            const [unansweredQueries, setUnansweredQueries] = useState([]); // List of problematic queries
            
            // Generate or retrieve session ID from localStorage for chat history persistence
            const [sessionId] = useState(() => {
                let id = localStorage.getItem('chatSessionId');
                if (!id) {
                    id = 'user_' + Date.now(); // Create unique session ID
                    localStorage.setItem('chatSessionId', id);
                }
                return id;
            });
            
            const messagesEndRef = useRef(null); // Reference for auto-scrolling

            /**
             * Scrolls chat window to bottom (latest message)
             */
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            // Auto-scroll when new messages arrive or loading state changes
            useEffect(() => {
                scrollToBottom();
            }, [messages, isLoading]);

            // Load chat history and unanswered queries count when component mounts
            useEffect(() => {
                loadHistory();
                // Load unanswered queries count for the badge
                fetch('http://localhost:3000/api/unanswered')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            setUnansweredQueries(data.queries);
                        }
                    })
                    .catch(err => console.error('Error loading unanswered count:', err));
            }, []);

            /**
             * Loads chat history for current session from server
             */
            const loadHistory = async () => {
                try {
                    const response = await fetch(`http://localhost:3000/api/history/${sessionId}`);
                    const data = await response.json();

                    if (data.success && data.history.length > 0) {
                        // Convert history to message format with messageId and feedback
                        const historyMessages = [];
                        data.history.forEach(chat => {
                            historyMessages.push({ 
                                text: chat.userMessage, 
                                isUser: true,
                                timestamp: chat.timestamp
                            });
                            historyMessages.push({ 
                                text: chat.botResponse, 
                                isUser: false,
                                messageId: chat.messageId,
                                userQuestion: chat.userMessage,
                                feedbackType: chat.feedbackType,
                                timestamp: chat.timestamp
                            });
                        });
                        setMessages(historyMessages);
                    } else {
                        // Show welcome message if no history exists
                        setMessages([{ 
                            text: "Hello! I'm your FAQ Chatbot. How can I help you today?", 
                            isUser: false 
                        }]);
                    }
                } catch (error) {
                    console.error('Error loading history:', error);
                    // Fallback to welcome message on error
                    setMessages([{ 
                        text: "Hello! I'm your FAQ Chatbot. How can I help you today?", 
                        isUser: false 
                    }]);
                }
            };

            /**
             * Loads all chat history from all sessions (for History button)
             */
            const loadAllHistory = async () => {
                try {
                    const response = await fetch('http://localhost:3000/api/history');
                    const data = await response.json();

                    if (data.success && data.history.length > 0) {
                        // Convert all history to message format with feedback data
                        const allMessages = [];
                        data.history.forEach(chat => {
                            allMessages.push({ 
                                text: chat.userMessage, 
                                isUser: true,
                                timestamp: chat.timestamp
                            });
                            allMessages.push({ 
                                text: chat.botResponse, 
                                isUser: false,
                                messageId: chat.messageId,
                                userQuestion: chat.userMessage,
                                feedbackType: chat.feedbackType,
                                timestamp: chat.timestamp
                            });
                        });
                        setMessages(allMessages);
                    } else {
                        alert('No chat history found in database.');
                    }
                } catch (error) {
                    console.error('Error loading all history:', error);
                    alert('Error loading chat history.');
                }
            };

            /**
             * Sends user message to server and displays response
             */
            const sendMessage = async () => {
                // Validate input
                if (!inputValue.trim()) return;

                const userMessage = inputValue.trim();
                setInputValue(''); // Clear input field
                
                // Add user message to chat immediately
                setMessages(prev => [...prev, { text: userMessage, isUser: true, timestamp: Date.now() }]);
                setIsLoading(true); // Show typing indicator

                try {
                    // Send message to API
                    const response = await fetch('http://localhost:3000/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMessage, sessionId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Add bot response to chat with messageId for feedback tracking
                        setMessages(prev => [...prev, { 
                            text: data.response, 
                            isUser: false,
                            messageId: data.messageId,
                            userQuestion: userMessage,
                            feedbackType: null,
                            timestamp: data.timestamp
                        }]);
                    } else {
                        // Show error message
                        setMessages(prev => [...prev, { 
                            text: 'Sorry, there was an error processing your message.', 
                            isUser: false 
                        }]);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    // Show connection error
                    setMessages(prev => [...prev, { 
                        text: 'Sorry, there was an error connecting to the server.', 
                        isUser: false 
                    }]);
                } finally {
                    setIsLoading(false); // Hide typing indicator
                }
            };

            /**
             * Handles feedback submission (thumbs up/down)
             * @param {string} messageId - Unique message identifier
             * @param {string} feedbackType - 'positive' or 'negative'
             * @param {string} userQuestion - The original user question
             * @param {string} botResponse - The bot's response
             */
            const handleFeedback = async (messageId, feedbackType, userQuestion, botResponse) => {
                try {
                    const response = await fetch('http://localhost:3000/api/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messageId,
                            feedbackType,
                            userQuestion,
                            botResponse,
                            sessionId
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update message feedback in UI
                        setMessages(prev => prev.map(msg => 
                            msg.messageId === messageId 
                                ? { ...msg, feedbackType }
                                : msg
                        ));
                        
                        // Show thank you message
                        if (feedbackType === 'positive') {
                            console.log('‚úÖ Thank you for your positive feedback!');
                        } else {
                            console.log('üìù Thank you! We\'ll work on improving this response.');
                        }
                    }
                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    alert('Failed to submit feedback. Please try again.');
                }
            };

            /**
             * Loads and displays unanswered/problematic queries
             */
            const loadUnansweredQueries = async () => {
                try {
                    const response = await fetch('http://localhost:3000/api/unanswered');
                    const data = await response.json();

                    if (data.success) {
                        setUnansweredQueries(data.queries);
                        setShowUnanswered(true);
                    }
                } catch (error) {
                    console.error('Error loading unanswered queries:', error);
                    alert('Error loading unanswered queries.');
                }
            };

            /**
             * Clears current chat session
             */
            const clearChat = async () => {
                if (confirm('Are you sure you want to clear the chat?')) {
                    try {
                        // Call clear API endpoint
                        await fetch('http://localhost:3000/api/clear', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sessionId })
                        });
                        
                        // Reset messages with welcome text
                        setMessages([{ 
                            text: "Chat cleared! How can I help you?", 
                            isUser: false 
                        }]);
                    } catch (error) {
                        console.error('Error clearing chat:', error);
                    }
                }
            };

            // Render the chat interface
            return (
                <div className="gradient-animation min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-5xl h-[95vh] bg-gradient-to-br from-gray-900 to-black rounded-xl shadow-2xl border border-gray-800 flex flex-col overflow-hidden">
                        
                        {/* Header Section */}
                        <div className="bg-gradient-to-r from-gray-900 to-black border-b border-gray-800 px-6 py-4 flex items-center justify-between shadow-lg">
                            {/* Logo and Title */}
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-lg flex items-center justify-center">
                                    <span className="text-lg">ü§ñ</span>
                                </div>
                                <h1 className="text-xl font-semibold text-gray-200 tracking-wide">FAQ Chatbot</h1>
                            </div>
                            
                            {/* Action Buttons */}
                            <div className="flex gap-2">
                                {/* Unanswered Queries Button - View questions needing improvement */}
                                <button
                                    onClick={loadUnansweredQueries}
                                    className="px-4 py-2 bg-gradient-to-r from-orange-900 to-orange-800 hover:from-orange-800 hover:to-orange-700 text-white rounded-lg text-sm font-medium transition-all duration-300 border border-orange-700 hover:border-orange-600"
                                    title="View questions that need improvement"
                                >
                                    ‚ö†Ô∏è Review ({unansweredQueries.length})
                                </button>
                                
                                {/* History Button - View all past conversations */}
                                <button
                                    onClick={loadAllHistory}
                                    className="px-4 py-2 bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600 text-gray-300 rounded-lg text-sm font-medium transition-all duration-300 border border-gray-600 hover:border-gray-500"
                                    title="View all chat history"
                                >
                                    üìö History
                                </button>
                                
                                {/* Clear Button - Reset current conversation */}
                                <button
                                    onClick={clearChat}
                                    className="px-4 py-2 bg-gradient-to-r from-gray-800 to-gray-700 hover:from-red-900 hover:to-red-800 text-gray-300 hover:text-white rounded-lg text-sm font-medium transition-all duration-300 border border-gray-600 hover:border-red-700"
                                    title="Clear current chat"
                                >
                                    üóëÔ∏è Clear
                                </button>
                            </div>
                        </div>

                        {/* Messages Container */}
                        <div className="flex-1 overflow-y-auto bg-gradient-to-b from-black to-gray-900 custom-scrollbar">
                            {/* Render all messages with feedback functionality */}
                            {messages.map((msg, index) => (
                                <Message 
                                    key={index} 
                                    message={msg.text} 
                                    isUser={msg.isUser}
                                    messageId={msg.messageId}
                                    userQuestion={msg.userQuestion}
                                    onFeedback={handleFeedback}
                                    feedbackType={msg.feedbackType}
                                    timestamp={msg.timestamp}
                                />
                            ))}
                            
                            {/* Show typing indicator when bot is responding */}
                            {isLoading && <TypingIndicator />}
                            
                            {/* Invisible element for auto-scrolling */}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input Section */}
                        <div className="bg-gradient-to-r from-gray-900 to-black border-t border-gray-800 p-6">
                            <div className="flex gap-3">
                                {/* Message Input Field (textarea) */}
                                <textarea
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
                                            e.preventDefault();
                                            sendMessage();
                                        }
                                    }}
                                    placeholder="Type your message. Enter to send, Shift+Enter for newline..."
                                    rows="2"
                                    className="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-5 py-3 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-300 resize-none"
                                    disabled={isLoading}
                                    autoFocus
                                ></textarea>
                                
                                {/* Send Button */}
                                <button
                                    onClick={sendMessage}
                                    disabled={isLoading || !inputValue.trim()}
                                    className="px-6 py-3 bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-400 hover:to-emerald-500 text-black font-semibold rounded-lg transition-all duration-300 shadow-lg hover:shadow-teal-500/50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="Send message"
                                >
                                    {isLoading ? 'Sending...' : 'Send'}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Unanswered Queries Modal */}
                    {showUnanswered && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                            <div className="bg-gradient-to-br from-gray-900 to-black rounded-xl shadow-2xl border border-gray-700 w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
                                {/* Modal Header */}
                                <div className="bg-gradient-to-r from-orange-900 to-orange-800 px-6 py-4 flex items-center justify-between border-b border-orange-700">
                                    <div className="flex items-center gap-3">
                                        <span className="text-2xl">‚ö†Ô∏è</span>
                                        <h2 className="text-xl font-semibold text-white">
                                            Questions Needing Improvement
                                        </h2>
                                    </div>
                                    <button
                                        onClick={() => setShowUnanswered(false)}
                                        className="text-white hover:text-gray-200 text-2xl transition-colors"
                                        title="Close"
                                    >
                                        ‚úï
                                    </button>
                                </div>

                                {/* Modal Content */}
                                <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                                    {unansweredQueries.length === 0 ? (
                                        <div className="text-center py-12 text-gray-400">
                                            <div className="text-6xl mb-4">üéâ</div>
                                            <p className="text-lg">No problematic queries found!</p>
                                            <p className="text-sm mt-2">All responses have been rated positively.</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {unansweredQueries.map((query, index) => (
                                                <div key={query._id} className="bg-gray-800 border border-gray-700 rounded-lg p-5 hover:border-orange-600 transition-colors">
                                                    <div className="flex items-start gap-3 mb-3">
                                                        <span className="bg-orange-900 text-white px-2 py-1 rounded text-xs font-bold">
                                                            #{index + 1}
                                                        </span>
                                                        <div className="text-xs text-gray-500">
                                                            {new Date(query.timestamp).toLocaleString()}
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="space-y-3">
                                                        <div>
                                                            <div className="text-sm text-gray-400 mb-1 font-semibold">‚ùì User Question:</div>
                                                            <div className="text-gray-200 bg-gray-900 p-3 rounded border border-gray-700">
                                                                {query.userQuestion}
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <div className="text-sm text-gray-400 mb-1 font-semibold">ü§ñ Bot Response:</div>
                                                            <div className="text-gray-300 bg-gray-900 p-3 rounded border border-gray-700">
                                                                {query.botResponse}
                                                            </div>
                                                        </div>

                                                        <div className="flex items-center gap-2 text-xs text-red-400">
                                                            <span>üëé</span>
                                                            <span>Marked as not helpful</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Modal Footer */}
                                <div className="bg-gray-900 px-6 py-4 border-t border-gray-800">
                                    <button
                                        onClick={() => setShowUnanswered(false)}
                                        className="w-full px-4 py-2 bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 text-white rounded-lg font-medium transition-all duration-300"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Initialize and render the React app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatApp />);
    </script>
</body>
</html>
